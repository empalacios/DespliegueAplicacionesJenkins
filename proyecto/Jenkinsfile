pipeline {
  agent any

  stages {
    stage('build') {
      steps {
        sh '/opt/apache-maven-3.6.2/bin/mvn -f ProductosApp clean package'
      }
    }

    stage('deploy') {
      steps {
        sh 'ssh jenkins@172.17.0.1 docker stop app || echo No existe un contenedor para el servidor de aplicaciones'
        sh 'ssh jenkins@172.17.0.1 docker rm app || true'
        sh 'ssh jenkins@172.17.0.1 rm -f /payara-apps/ProductosApp.war'
        sh 'scp ProductosApp/target/ProductosApp-1.0-SNAPSHOT.war jenkins@172.17.0.1:/payara-apps/ProductosApp.war'
        sh 'ssh jenkins@172.17.0.1 docker run -p 4848:4848 -d --name=app -v /payara-apps:/opt/payara/deployments app'
      }
    }
  }

  post {
    success {
      sh 'echo El proceso de despliegue termino exitosamente'
    }

    failure {
      sh 'echo Hubo un error al momento de desplegar la aplicacion'
    }
  }
}
